Mini RAG Assistant - Architecture Diagrams (Updated with Text Highlighting)
============================================================================

1. High-Level System Architecture (with Multi-Turn Conversation)
----------------------------------------------------------------

+--------+       +---------------------------------------------+
|  User  | ----> |                Streamlit UI                 |
+--------+       |                  (app.py)                   |
                 +----------------------+----------------------+
                                        |
                                        v
                            +-----------------------+
                            |     Orchestrator      |
                            | (Session State Logic) |
                            |  + Provider Switcher  |
                            |  + Chat History Mgmt  |
                            +-----------+-----------+
                                        |
      +---------------------------------+----------------------------------+
      |                                 |                                  |
      | INGESTION FLOW                  | QUERY FLOW                       |
      v                                 v                                  v
+-----------------------+     +-----------------------+          +-----------------------+
|  Document Processor   |     |  Vector Store Manager |          |  Multi-Turn Handler   |
| (PyPDF2 / TxtSplit)   |     | (Embeddings & FAISS)  |          | • Context Builder     |
| + Auto Loader         |     | + Similarity Search   |          | • Query Enhancement   |
+-----------+-----------+     +-----------+-----------+          +-----------+-----------+
            |                             |                                  |
            | Chunks                      | Creates/Reads                    | Enhanced Query
            v                             v                                  v
+-----------------------+     +-----------------------+          +-----------------------+
|   Vector Store Add    |---->|      FAISS Index      |          |     RAG Pipeline      |
|   (Gen Embeddings)    |     |  (vector_store_*)     |          | (Prompt & Inference)  |
+-----------------------+     +-----------------------+          | + Confidence Scoring  |
                                        |                        | + History Integration |
                                        | Context                +-----------+-----------+
                                        +--------------------------->        |
                                                                             | Generates
                                                                             v
                                                                 +-----------------------+
                                                                 |      LLM Provider     |
                                                                 |   (OpenAI / Ollama)   |
                                                                 +-----------+-----------+
                                                                             |
                                                                             v
                                                                 +-----------------------+
                                                                 |   Response Builder    |
                                                                 | + Source Attribution  |
                                                                 | + Confidence Score    |
                                                                 +-----------+-----------+
                                                                             |
                                                                             v
                                                                 +-----------------------+
                                                                 |  Text Highlighting    |
                                                                 | • Keyword Matching    |
                                                                 | • Semantic Similarity |
                                                                 | • Visual Rendering    |
                                                                 +-----------+-----------+
                                                                             |
                                                                             v
                                                                 +-----------------------+
                                                                 |  Update Chat History  |
                                                                 | (session_state)       |
                                                                 +-----------------------+


2. The "Strategy Pattern" for Providers
---------------------------------------

This diagram illustrates how the application switches between OpenAI and Ollama 
implementation classes based on your selection.

                   User Selects Provider
                       (Radio Button)
                             |
                             v
                +-------------------------+
                |  initialize_components  |
                +------------+------------+
                             |
              +--------------+--------------+
              |                             |
              v                             v
     [ IF OPENAI SELECTED ]        [ IF OLLAMA SELECTED ]
              |                             |
  +-----------------------+     +-----------------------+
  | Loads:                |     | Loads:                |
  | src.vector_store      |     | src.vector_store_ollama
  | src.rag_pipeline      |     | src.rag_pipeline_ollama
  +-----------+-----------+     +-----------+-----------+
              |                             |
              v                             v
  +-----------------------+     +-----------------------+
  | • OpenAIEmbeddings    |     | • HuggingFaceEmbeddings
  | • ChatOpenAI (GPT-4)  |     | • Ollama (Local)      |
  | • text-embedding-3    |     | • all-minilm-l6-v2    |
  +-----------------------+     +-----------------------+
              |                             |
              +-------------+---------------+
                            |
                            v
              +---------------------------+
              |   Shared Vector Store     |
              |   (vector_store_openai/   |
              |    vector_store_ollama)   |
              +---------------------------+


3. Query Processing Flow with Text Highlighting & Multi-Turn
-------------------------------------------------------------

+--------+
|  User  |
| Query  |
+----+---+
     |
     v
+--------------------+
| Multi-Turn Handler |
| (if enabled)       |
+--------+-----------+
         |
         +---> Check Session State
         |     for chat_history
         |
         +---> Extract last 3 Q&A pairs
         |
         +---> Enhance query with
         |     conversation context
         |
         v
+--------------------+
| Vector Store       |
| Similarity Search  |
| (k=4 by default)   |
+--------+-----------+
         |
         | Retrieved Documents
         | (with relevance scores)
         v
+--------------------+
| RAG Pipeline       |
| • Format Context   |
| • Include History  |
| • Generate Answer  |
| • Calculate        |
|   Confidence       |
+--------+-----------+
         |
         | Answer + Sources
         v
+--------------------+
| Text Highlighting  |
| Engine             |
+--------+-----------+
         |
         +---> 1. Extract Query Keywords
         |
         +---> 2. Tokenize Source Text
         |
         +---> 3. Compute Embeddings
         |     (for semantic similarity)
         |
         +---> 4. Highlight Matches:
         |     • Exact keywords (yellow)
         |     • Semantic similar (green)
         |
         v
+--------------------+
| Streamlit UI       |
| • Answer Display   |
| • Confidence Badge |
| • Source Cards     |
|   with Highlights  |
+--------+-----------+
         |
         v
+--------------------+
| Update Chat History|
| Store Q&A pair in  |
| session_state      |
+--------------------+


4. Document Ingestion & Auto-Loading Flow
-----------------------------------------

+------------------+
|   docs/ folder   |
| (PDF, TXT files) |
+--------+---------+
         |
         v
+--------------------+
| DocumentAutoLoader |
| • Scan folder      |
| • Check metadata   |
| • Find new files   |
+--------+-----------+
         |
         | Unprocessed Files
         v
+--------------------+
| DocumentProcessor  |
| • Load PDF/TXT     |
| • Split into chunks|
| • Add metadata     |
+--------+-----------+
         |
         | Document Chunks
         v
+--------------------+
| Vector Store       |
| • Generate         |
|   Embeddings       |
| • Store in FAISS   |
| • Save to disk     |
+--------+-----------+
         |
         v
+--------------------+
| Update Metadata    |
| (processed_files   |
|  .json)            |
+--------------------+


5. Text Highlighting Architecture
---------------------------------

                    Retrieved Source Text
                            |
                            v
              +---------------------------+
              |   Highlighting Engine     |
              +---------------------------+
                            |
              +-------------+-------------+
              |                           |
              v                           v
    +------------------+        +------------------+
    | Keyword Matcher  |        | Semantic Matcher |
    | • Tokenize query |        | • Embed query    |
    | • Find exact     |        | • Embed sentences|
    |   matches        |        | • Cosine         |
    | • Mark positions |        |   similarity     |
    +--------+---------+        +--------+---------+
             |                           |
             v                           v
    +------------------+        +------------------+
    | Yellow Highlight |        | Green Highlight  |
    | (Exact matches)  |        | (Semantic match) |
    +--------+---------+        +--------+---------+
             |                           |
             +-------------+-------------+
                           |
                           v
              +---------------------------+
              |   HTML Rendering          |
              | • <mark> tags             |
              | • Color coding            |
              | • Intensity by score      |
              +---------------------------+
                           |
                           v
              +---------------------------+
              |   Streamlit Display       |
              | • Source cards            |
              | • Expandable sections     |
              | • Relevance badges        |
              +---------------------------+


6. Session State & Chat History Management
-----------------------------------------

                    +---------------------------+
                    |   Streamlit Session State |
                    +---------------------------+
                                |
                +---------------+---------------+
                |               |               |
                v               v               v
    +------------------+ +------------------+ +------------------+
    | chat_history     | | current_provider | | vector_store_    |
    | (list of Q&A)    | | (openai/ollama)  | | manager          |
    +------------------+ +------------------+ +------------------+
                |
                v
    +---------------------------+
    | Each entry contains:      |
    | • question (str)          |
    | • result (dict):          |
    |   - answer                |
    |   - confidence            |
    |   - sources[]             |
    |   - highlight_legend      |
    +---------------------------+
                |
                v
    +---------------------------+
    | When provider switches:   |
    | • Clear chat_history      |
    | • Reset auto_loaded flag  |
    | • Reinitialize components |
    +---------------------------+


7. Multi-Turn Conversation Flow (Detailed)
------------------------------------------

                    User asks follow-up question
                              |
                              v
                  +-----------------------+
                  | Check if Multi-Turn   |
                  | is enabled (checkbox) |
                  +-----------+-----------+
                              |
                +-------------+-------------+
                |                           |
                v                           v
        [ ENABLED ]                  [ DISABLED ]
                |                           |
                v                           |
    +-----------------------+               |
    | Retrieve last 3 Q&A   |               |
    | pairs from chat_history|              |
    +-----------+-----------+               |
                |                           |
                v                           |
    +-----------------------+               |
    | Build conversation    |               |
    | context array:        |               |
    | [{question, answer}]  |               |
    +-----------+-----------+               |
                |                           |
                v                           |
    +-----------------------+               |
    | Enhance query by      |               |
    | combining with last   |               |
    | question:             |               |
    | "prev_q current_q"    |               |
    +-----------+-----------+               |
                |                           |
                +-------------+-------------+
                              |
                              v
                  +-----------------------+
                  | Pass to RAG Pipeline: |
                  | • Enhanced query      |
                  | • Conversation history|
                  +-----------+-----------+
                              |
                              v
                  +-----------------------+
                  | Build LLM Prompt:     |
                  | • System instructions |
                  | • Previous Q&A pairs  |
                  | • Current question    |
                  | • Retrieved documents |
                  +-----------+-----------+
                              |
                              v
                  +-----------------------+
                  | LLM generates answer  |
                  | considering full      |
                  | conversation context  |
                  +-----------+-----------+
                              |
                              v
                  +-----------------------+
                  | Store new Q&A pair in |
                  | chat_history          |
                  | (session_state)       |
                  +-----------------------+


8. Data Flow Summary
-------------------

Documents → Chunks → Embeddings → FAISS Index
                                       ↓
User Query → Multi-Turn Context → Embedding → Similarity Search → Top-K Documents
                                                                          ↓
                                                                  RAG Pipeline
                                                                  (with history)
                                                                          ↓
                                                              LLM (OpenAI/Ollama)
                                                                          ↓
                                                              Answer + Confidence
                                                                          ↓
                                                              Text Highlighting
                                                                          ↓
                                                              UI Display with
                                                              Highlighted Sources
                                                                          ↓
                                                              Update Chat History

